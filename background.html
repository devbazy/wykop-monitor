<script>
    var pollIntervalMin = 1000 * 60;  // 1 minute
    var pollIntervalMax = 1000 * 60 * 10; // 10 minutes
    var requestFailureCount = 0;  // used for exponential backoff
    var requestTimeout = 1000 * 15;
    var options = {};
    var scheduled = false;
    var notifications = [];
    var news = 0;
    var tid; // timeout id
    var logged = false;
    var api =  'http://a.wykop.pl/search/index/appkey,h7Rfg78hSg,output,clear';
    var urls = {};
    var tabs = {};
    
    function scheduleRequest() {
        if(!scheduled){
            scheduled = true;
            var randomness = Math.random() * 2;
            var exponent = Math.pow(2, requestFailureCount);
            var delay = Math.min(randomness * pollIntervalMin * exponent, 
            pollIntervalMax);
            delay = Math.round(delay);

            window.setTimeout(startRequest, delay); 
        }       
    }
    
    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
        console.log(request);
        
        clearTimeout(tid);
        
        if(request.news || logged != request.logged){
            startRequest();
        }else{
            scheduleRequest();   
        }
        
        var newstemp = news;
        
        if(request.hasOwnProperty('logged')){
            logged = request.logged;
            updateIcon();           
        }        
        
        if(request.hasOwnProperty('notifications')){
            notifications = request.notifications;
            
            if(sender.tab){
                // real browser - clear new counter               
                news = 0;
            }else {
                var badge = 0;
                for(var i = 0; i < notifications.length; i++){
                    if(notifications[i]['new']){
                        badge++;
                    }
                }
                news += badge;
            }
        }
        localStorage.news = news;
        sendResponse({
            news: news,
            newstemp: newstemp
        });
        updateBadge();
    });

    function updateBadge(tabId){
        if(news){
            chrome.browserAction.setBadgeBackgroundColor({
                color: [255, 0, 0, 255]
            });
            
            chrome.browserAction.setBadgeText({
                text: news.toString()
            });
            
            // force diggs overwrite
            for(var id in tabs){
                if(tabs[id]){
                    // keys in object are always strings...
                    id = parseInt(id, 10);
                    chrome.browserAction.setBadgeBackgroundColor({
                        color: [255, 0, 0, 255],
                        tabId : id
                    });
            
                    chrome.browserAction.setBadgeText({
                        text: news.toString(),
                        tabId : id
                    });
                }
            }
        } else {
            for(var id in tabs){
                if(tabs[id]){
                    // keys in object are always strings...
                    id = parseInt(id, 10);
                   
                    chrome.browserAction.setBadgeBackgroundColor({                
                        color :  [87, 153, 195, 255],
                        tabId : id
                    });
            
                    chrome.browserAction.setBadgeText({
                        text : tabs[id].toString(),
                        tabId : id
                    });
                }else {
                    
                }
            }
            chrome.browserAction.setBadgeText({
                text: ''
            });
        }
    }
    
    function updateIcon(){
        if(logged){
            chrome.browserAction.setIcon({
                path: 'img/19.png'
            });
        }else {
            chrome.browserAction.setIcon({
                path: 'img/19bw.png'
            });
        }
    }
    
    function startRequest() {
        scheduled = false;
        
        document.getElementById('temp').src = 'http://www.wykop.pl/moj/powiadomienia/';  
         
        tid = setTimeout(function(){
            // probably logged out
            console.log('timeout');
            logged = false;
            updateIcon();
            scheduleRequest();
        }, requestTimeout); 
    }
    
    chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
        var url = tab.url;
        var tid = tabId;
        
        if (changeInfo.url) {
            if (changeInfo.url.match(/^http/) && !changeInfo.url.match(/^.*\.wykop.pl\//) ){
                var xhr = new XMLHttpRequest();                
                try {
                    xhr.onreadystatechange = function(){
                        if (xhr.readyState != 4){
                            return;
                        }
                
                        if (xhr.status == 200 && xhr.responseText != ""){
                            var response = JSON.parse(xhr.responseText);
                        
                            if (response.length > 0 && url == response[0].source_url ) {
                                urls[url] = response[0];
                                tabs[tid] = urls[url].vote_count;
                            } else {
                                urls[url] = null;
                                tabs[tid] = 0;
                            }
                            updateBadge(tid);
                        }
                    }
                    xhr.open('POST', api, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.send('url=' + encodeURIComponent(changeInfo.url));
                }catch(e){
                    console.log('xhr exception');
                }
            }
        }
        
        if (urls.hasOwnProperty(url) && urls[url]){
            tabs[tid] = urls[url].vote_count;
            updateBadge(tid);
        }else {
            updateBadge();
        } 
    });
    
    window.onload = function(){
        if(localStorage.news){
            news = parseInt(localStorage.news, 10);
            news = isNaN(news) ? 0 : news;
        }
        updateBadge();
        startRequest();
    }    
</script>
<iframe id="temp"></iframe>