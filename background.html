<script>
    var pollIntervalMin = 1000 * 60;  // 1 minute
    var pollIntervalMax = 1000 * 60 * 10; // 10 minutes
    var requestFailureCount = 0;  // used for exponential backoff
    var requestTimeout = 1000 * 10;
    var options = {};
    var scheduled = false;
    var notifications = [];
    var news = 0;
    var tid; // timeout id
    var logged = false;
    var api =  'http://a.wykop.pl/search/index/appkey,h7Rfg78hSg,output,clear';
    var urls = {};
    
    function scheduleRequest() {
        if(!scheduled){
            scheduled = true;
            var randomness = Math.random() * 2;
            var exponent = Math.pow(2, requestFailureCount);
            var delay = Math.min(randomness * pollIntervalMin * exponent, 
            pollIntervalMax);
            delay = Math.round(delay);

            window.setTimeout(startRequest, delay); 
        }       
    }
    
    chrome.extension.onRequest.addListener(function(request, sender) {
        console.log(request);
        
        clearTimeout(tid);
        
        if(request.news || logged != request.logged){
            startRequest();
        }else{
            scheduleRequest();   
        }
        
        logged = request.logged;
        
        if(logged){
            chrome.browserAction.setIcon({
                path: 'img/19.png'
            });
        }else {
            chrome.browserAction.setIcon({
                path: 'img/19bw.png'
            });
        }
        
        if(request.hasOwnProperty('notifications')){
            notifications = request.notifications;
            
            if(sender.tab){
                // real browser
                news = 0;
            }else {
                var badge = 0;
                for(var i = 0; i < notifications.length; i++){
                    if(notifications[i]['new']){
                        badge++;
                    }
                }
                news += badge;
            }
        }
       
        setBadge();
    });

    function setBadge(){
        if(news){
            chrome.browserAction.setBadgeBackgroundColor({
                color: [255, 0, 0, 255]
            });
            
            chrome.browserAction.setBadgeText({
                text: news.toString()
            });
        }else {
            chrome.browserAction.setBadgeText({
                text: ''
            });
        }
    }
    
    function startRequest() {
        scheduled = false;
        
        document.getElementById('temp').src = 'http://www.wykop.pl/moj/powiadomienia/';  
         
        tid = setTimeout(function(){
            // probably logged out
            chrome.browserAction.setIcon({
                path: 'img/19bw.png'
            });
            
            logged = false;
            scheduleRequest();
        }, requestTimeout); 
    }
    
    function setDiggs(tabId, diggs){
        // set diggs only where is no notifications
        if(!news){
            chrome.browserAction.setBadgeBackgroundColor({                
                color :  [87, 153, 195, 255],
                tabId : tabId
            });
            
            chrome.browserAction.setBadgeText({
                text : diggs.toString(),
                tabId : tabId
            });
        }
    }
    
    chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
        var url = tab.url;
        var tid = tabId;
        
        setBadge();
        
        if (changeInfo.url) {
            if (changeInfo.url.match(/^http/) && !changeInfo.url.match(/^.*\.wykop.pl\//) ){
                var xhr = new XMLHttpRequest();                
                try {
                    xhr.onreadystatechange = function(){
                        if (xhr.readyState != 4){
                            return;
                        }
                
                        if (xhr.status == 200 && xhr.responseText != ""){
                            var response = JSON.parse(xhr.responseText);
                        
                            if (response.length > 0 && url == response[0].source_url ) {
                                urls[url] = response[0];
                                setDiggs(tid, urls[url].vote_count);
                            } else {
                                urls[url] = null;                            
                            }
                        }
                    }
                    xhr.open('POST', api, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.send('url=' + encodeURIComponent(changeInfo.url));
                }catch(e){
                    console.log('xhr exception');
                }
            }
        }
        
        if (urls.hasOwnProperty(url) && urls[url]){
            setDiggs(tid, urls[url].vote_count);
        } 
    });
    
    window.onload = function(){
        startRequest();    
    }    
</script>
<iframe id="temp"></iframe>