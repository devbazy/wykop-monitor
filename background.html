<script>
    var pollIntervalMin = 1000 * 60;  // 1 minute
    var pollIntervalMax = 1000 * 60 * 10; // 10 minutes
    var requestFailureCount = 0;  // used for exponential backoff
    var requestTimeout = 1000 * 10;
    var options = {};
    var scheduled = false;
    var notifications = [];
    var news = 0;
    var tid; // timeout id
    var logged = false;
    
    chrome.browserAction.setBadgeBackgroundColor({
        color: [255, 0, 0, 255]
    });
    
    function scheduleRequest() {
        if(!scheduled){
            scheduled = true;
            var randomness = Math.random() * 2;
            var exponent = Math.pow(2, requestFailureCount);
            var delay = Math.min(randomness * pollIntervalMin * exponent, 
            pollIntervalMax);
            delay = Math.round(delay);

            window.setTimeout(startRequest, delay); 
        }       
    }
    
    chrome.extension.onRequest.addListener(function(request, sender) {
        console.log(request);
        
        clearTimeout(tid);
        logged = request.logged;
        
        if(request.hasOwnProperty('notifications')){
            notifications = request.notifications;
            
            if(sender.tab){
                // real browser
                news = 0;
            }else {
                var badge = 0;
                for(var i = 0; i < notifications.length; i++){
                    if(notifications[i]['new']){
                        badge++;
                    }
                }
                news += badge;
            }
        }
       
        setBadge();
            
        if(request.news){
            startRequest();
        }else{
            scheduleRequest();   
        }
    });

    function setBadge(){
        if(news){
            chrome.browserAction.setBadgeText({
                text: news.toString()
            });
        }else {
            chrome.browserAction.setBadgeText({
                text: ''
            });
        }
    }
    
    function startRequest() {
        scheduled = false;
        
        document.getElementById('temp').src = 'http://www.wykop.pl/moj/powiadomienia/';  
         
        tid = setTimeout(function(){
            // probably logged out
            chrome.browserAction.setBadgeText({
                text: "!"
            });
            logged = false;
            scheduleRequest();
        }, requestTimeout); 
    }
    window.onload = function(){
        startRequest();    
    }    
</script>
<iframe id="temp"></iframe>